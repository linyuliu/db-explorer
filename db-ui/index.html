<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全功能数据库浏览器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://rsms.me/inter/inter.css');
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
            appearance: none;
            -moz-appearance: none;
            -webkit-appearance: none;
        }
        /* 自定义滚动条样式，使其更美观 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

<div id="app" class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">

    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 tracking-tight">全功能数据库浏览器</h1>
        <p class="text-lg text-gray-600 mt-2">一个支持多版本驱动和多种数据库的Web工具</p>
    </header>

    <div class="grid lg:grid-cols-12 gap-8">
        <!-- 左侧：配置区域 -->
        <div class="lg:col-span-4 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 h-fit">
            <h2 class="text-xl font-semibold mb-6 border-b pb-3 text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                连接配置
            </h2>
            <form @submit.prevent="fetchData" class="space-y-4">
                <div>
                    <label for="db-type" class="block text-sm font-medium text-gray-700 mb-1">数据库类型</label>
                    <select v-model="form.databaseType" @change="onDbTypeChange" id="db-type" class="form-select mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition">
                        <option v-for="db in dbTypes" :key="db.value" :value="db.value">{{ db.name }}</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="host" class="block text-sm font-medium text-gray-700 mb-1">主机</label>
                        <input v-model="form.host" type="text" id="host" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition" placeholder="localhost">
                    </div>
                    <div>
                        <label for="port" class="block text-sm font-medium text-gray-700 mb-1">端口</label>
                        <input v-model.number="form.port" type="number" id="port" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition">
                    </div>
                </div>
                <div>
                    <label for="database" class="block text-sm font-medium text-gray-700 mb-1">{{ dbNameLabel }}</label>
                    <input v-model="form.database" type="text" id="database" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition">
                </div>
                 <div v-if="selectedDbType.supportsSchema">
                    <label for="schema" class="block text-sm font-medium text-gray-700 mb-1">模式 (Schema)</label>
                    <input v-model="form.schema" type="text" id="schema" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition" :placeholder="selectedDbType.schemaHint">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <input v-model="form.username" type="text" id="username" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition" placeholder="root">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <input v-model="form.password" type="password" id="password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition" placeholder="******">
                    </div>
                </div>

                <button type="submit" :disabled="loading" class="w-full mt-6 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-150 ease-in-out disabled:bg-blue-400 disabled:cursor-not-allowed flex items-center justify-center">
                    <svg v-if="loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>{{ loading ? '正在连接...' : '连接并获取表结构' }}</span>
                </button>
            </form>
        </div>

        <!-- 右侧：结果区域 -->
        <div class="lg:col-span-8 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 flex flex-col" style="height: 70vh;">
            <h2 class="text-xl font-semibold mb-4 border-b pb-3 text-gray-800 flex items-center flex-shrink-0">
                <svg class="w-6 h-6 mr-2 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                查询结果
            </h2>
            
            <div v-if="error" class="bg-red-50 border-l-4 border-red-500 text-red-800 p-4 rounded-lg my-4" role="alert">
                <p class="font-bold">发生错误</p>
                <p class="text-sm mt-1 break-all">{{ error }}</p>
            </div>
            
            <div v-if="!error && !result && !loading" class="text-center text-gray-500 py-16 flex-grow flex flex-col justify-center items-center">
                 <svg class="mx-auto h-20 w-20 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                </svg>
                <p class="mt-4 text-base font-medium">请先配置并连接数据库</p>
                <p class="text-sm text-gray-400 mt-1">结果将在此处显示</p>
            </div>

            <div v-if="result" class="flex flex-col flex-grow min-h-0">
                 <div class="mb-4 p-3 bg-gray-50 rounded-lg border flex-shrink-0">
                    <p class="text-sm text-gray-600">
                        在数据库 <strong class="font-semibold text-blue-700">{{ result.database }}</strong> 
                        <span v-if="result.schema">的模式 <strong class="font-semibold text-blue-700">{{ result.schema }}</strong></span> 
                        中找到 <strong class="font-semibold text-blue-700">{{ result.tables.length }}</strong> 个表/视图：
                    </p>
                 </div>
                 
                 <div class="relative mb-4 flex-shrink-0">
                    <input type="text" v-model="searchTerm" placeholder="搜索表名..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>

                 <div class="overflow-y-auto flex-grow custom-scrollbar">
                     <ul class="divide-y divide-gray-200">
                        <li v-for="table in filteredTables" :key="table" class="py-3 flex items-center hover:bg-gray-50 rounded-md px-2 -mx-2 transition-colors">
                            <svg class="h-5 w-5 text-gray-400 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <span class="text-gray-800 font-medium select-all">{{ table }}</span>
                        </li>
                    </ul>
                    <p v-if="filteredTables.length === 0 && result.tables.length > 0" class="text-center text-gray-500 mt-8">未找到匹配的表。</p>
                 </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const dbTypes = ref([
                { value: 'mysql8', name: 'MySQL 8.x+', port: 3306, dbLabel: '数据库', dbDefault: 'mysql', supportsSchema: false },
                { value: 'mysql5', name: 'MySQL 5.x', port: 3306, dbLabel: '数据库', dbDefault: 'mysql', supportsSchema: false },
                { value: 'postgresql', name: 'PostgreSQL', port: 5432, dbLabel: '数据库', dbDefault: 'postgres', supportsSchema: true, schemaHint: '例如: public' },
                { value: 'oracle', name: 'Oracle', port: 1521, dbLabel: '服务名 / SID', dbDefault: 'ORCL', supportsSchema: true, schemaHint: '通常为用户名大写' },
                { value: 'sqlserver', name: 'SQL Server', port: 1433, dbLabel: '数据库', dbDefault: 'master', supportsSchema: true, schemaHint: '例如: dbo' },
                { value: 'dameng', name: '达梦 (Dameng)', port: 5236, dbLabel: '数据库', dbDefault: 'SYSTEM', supportsSchema: true, schemaHint: '例如: SYS' },
                { value: 'kingbase', name: '人大金仓 (KingbaseES)', port: 54321, dbLabel: '数据库', dbDefault: 'postgres', supportsSchema: true, schemaHint: '例如: public' },
            ]);

            const form = ref({
                databaseType: 'mysql8',
                host: 'localhost',
                port: 3306,
                database: 'mysql',
                schema: '',
                username: 'root',
                password: '',
            });

            const result = ref(null);
            const error = ref(null);
            const loading = ref(false);
            const searchTerm = ref('');

            const selectedDbType = computed(() => dbTypes.value.find(db => db.value === form.value.databaseType));
            const dbNameLabel = computed(() => selectedDbType.value?.dbLabel || '数据库');
            
            const filteredTables = computed(() => {
                if (!result.value || !result.value.tables) return [];
                if (!searchTerm.value) return result.value.tables;
                return result.value.tables.filter(table => 
                    table.toLowerCase().includes(searchTerm.value.toLowerCase())
                );
            });

            const onDbTypeChange = () => {
                const db = selectedDbType.value;
                if (db) {
                    form.value.port = db.port;
                    form.value.database = db.dbDefault;
                    form.value.schema = ''; // 重置 schema
                }
            };

            const fetchData = async () => {
                loading.value = true;
                error.value = null;
                result.value = null;
                try {
                    const response = await axios.post('http://localhost:8080/api/connect', form.value);
                    if (response.data && response.data.tables) {
                        response.data.tables.sort();
                    }
                    result.value = response.data;
                } catch (err) {
                     if (err.response && err.response.data && err.response.data.error) {
                        error.value = `[${err.response.status}] ${err.response.data.error}`;
                    } else if (err.request) {
                        error.value = '无法连接到后端服务。请检查后端服务是否已在 8080 端口启动，并确认网络连接没有问题。';
                    } else {
                        error.value = '请求发送失败: ' + err.message;
                    }
                    console.error(err);
                } finally {
                    loading.value = false;
                }
            };
            
            // 初始化表单
            onDbTypeChange();

            return {
                dbTypes,
                form,
                result,
                error,
                loading,
                searchTerm,
                filteredTables,
                selectedDbType,
                dbNameLabel,
                onDbTypeChange,
                fetchData
            };
        }
    }).mount('#app');
</script>

</body>
</html>

